
---
- name: Verify DNS & NTP on Windows
  hosts: windows
  gather_facts: false
  tasks:
    - name: Check w32tm peers
      ansible.windows.win_shell: w32tm /query /peers
      register: peers_out
      changed_when: false

    - name: Assert NTP server configured
      ansible.builtin.assert:
        that:
          - peers_out.stdout is search(ntp_server)
        fail_msg: "Expected NTP server '{{ ntp_server }}' not found in w32tm peers"

    - name: Check DNS servers
      ansible.windows.win_shell: |
        Get-DnsClientServerAddress -AddressFamily IPv4 | Select-Object -ExpandProperty ServerAddresses
      register: dns_out
      changed_when: false

    - name: Assert DNS servers include expected set
      ansible.builtin.assert:
        that:
          - (dns_out.stdout_lines | select('in', dns_servers) | list | length) == (dns_servers | length)
        fail_msg: "Not all expected DNS servers are set: {{ dns_servers | join(', ') }}"
